<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãã‚‹ã¿ã‚‚!æ¼¢å­—ã‚«ãƒ¼ãƒ‰</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'HGSeikaishotaiPRO', 'UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“ NK-R', 'Hiragino Mincho ProN', 'HiraginoMinchoPron', 'HGPå‰µè‹±è§’ï¾ï¾Ÿï½¯ï¾Œï¾Ÿä½“', serif;
      background: linear-gradient(135deg, #E6B0FF 0%, #FFB6D9 25%, #FFC9E3 50%, #D4A5F5 75%, #FFE5F1 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      background: linear-gradient(135deg, #FF69B4, #DA70D6, #FF69B4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2.2em;
      text-shadow: none;
      margin-bottom: 30px;
      animation: bounce 2s infinite;
      filter: drop-shadow(3px 3px 0px rgba(255, 182, 217, 0.5));
    }

    h1 .small-text {
      font-size: 0.7em;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .menu {
      background: white;
      border-radius: 25px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(255, 105, 180, 0.3);
      margin-bottom: 20px;
    }

    .menu h2 {
      color: #FF69B4;
      font-size: 1.8em;
      margin-bottom: 20px;
      text-align: center;
      display: none;
    }

    .button-group {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .mode-btn {
      background: linear-gradient(135deg, #FF69B4, #DA70D6, #B19CD9);
      color: white;
      border: none;
      padding: 20px;
      border-radius: 15px;
      font-size: 1.3em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 5px 15px rgba(218, 112, 214, 0.4);
    }

    .mode-btn:nth-child(1) {
      background: linear-gradient(135deg, #FF69B4, #FF1493, #DA70D6);
    }

    .mode-btn:nth-child(2) {
      background: linear-gradient(135deg, #DA70D6, #BA55D3, #9370DB);
    }

    .mode-btn:nth-child(3) {
      background: linear-gradient(135deg, #FF69B4, #FF85C1, #FFB6D9);
    }

    .mode-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 25px rgba(218, 112, 214, 0.6);
    }

    .mode-btn:active {
      transform: translateY(0);
    }

    .card-container {
      display: none;
    }

    .card {
      background: white;
      border-radius: 25px;
      padding: 60px 40px;
      min-height: 400px;
      box-shadow: 0 10px 30px rgba(255, 105, 180, 0.3);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      cursor: pointer;
      transition: transform 0.6s;
      transform-style: preserve-3d;
      position: relative;
      margin-bottom: 20px;
    }

    .card.flipped .card-front {
      transform: rotateY(180deg);
      opacity: 0;
    }

    .card.flipped .card-back {
      transform: rotateY(0deg);
      opacity: 1;
    }

    .card-front, .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      transition: all 0.6s;
      backface-visibility: hidden;
    }

    .card-back {
      transform: rotateY(-180deg);
      opacity: 0;
    }

    .question-text {
      font-size: 2.2em;
      line-height: 2;
      color: #333;
      font-family: 'HGæ­£æ¥·æ›¸ä½“-PRO', 'HGSeikaishotaiPRO', 'UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“ NK-R', 'Hiragino Mincho ProN', serif;
      font-weight: 500;
      letter-spacing: 0.1em;
    }

    .answer-text {
      font-size: 4.5em;
      background: linear-gradient(135deg, #FF69B4, #DA70D6, #9370DB);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: bold;
      font-family: 'HGæ­£æ¥·æ›¸ä½“-PRO', 'HGSeikaishotaiPRO', 'UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“ NK-R', 'Hiragino Mincho ProN', serif;
      letter-spacing: 0.15em;
    }

    .card-info {
      margin-bottom: 15px;
      text-align: center;
      background: linear-gradient(135deg, #FF69B4, #DA70D6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 1.2em;
      font-weight: bold;
    }

    .accuracy {
      font-size: 0.9em;
      color: #999;
      margin-top: 5px;
    }

    .button-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 20px;
    }

    .answer-btn {
      flex: 1;
      max-width: 250px;
      padding: 25px;
      font-size: 1.5em;
      font-weight: bold;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .correct-btn {
      background: linear-gradient(135deg, #FFB6D9, #FF69B4, #DA70D6);
      color: white;
    }

    .wrong-btn {
      background: linear-gradient(135deg, #D4A5F5, #B19CD9, #9370DB);
      color: white;
    }

    .answer-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .answer-btn:active {
      transform: translateY(0);
    }

    .result {
      display: none;
      background: white;
      border-radius: 25px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(255, 105, 180, 0.3);
      text-align: center;
    }

    .result h2 {
      background: linear-gradient(135deg, #FF69B4, #DA70D6, #9370DB);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2.5em;
      margin-bottom: 30px;
    }

    .result-stats {
      font-size: 1.5em;
      color: #333;
      margin-bottom: 30px;
    }

    .back-btn {
      background: linear-gradient(135deg, #FF69B4, #DA70D6, #9370DB);
      color: white;
      border: none;
      padding: 20px 40px;
      border-radius: 15px;
      font-size: 1.3em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 5px 15px rgba(218, 112, 214, 0.4);
    }

    .back-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(218, 112, 214, 0.6);
    }

    .loading {
      text-align: center;
      background: linear-gradient(135deg, #FF69B4, #DA70D6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 1.5em;
      margin-top: 50px;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 1.8em;
      }
      .question-text {
        font-size: 2em;
        line-height: 1.9;
      }
      .answer-text {
        font-size: 3.8em;
      }
      .button-container {
        flex-direction: column;
      }
      .answer-btn {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¦„ <span class="small-text">ãã‚‹ã¿ã‚‚!</span>æ¼¢å­—ã‚«ãƒ¼ãƒ‰ ğŸ’–</h1>

    <div id="menu" class="menu">
      <div class="button-group">
        <button class="mode-btn" onclick="startMode('normal')">ğŸ“š ã˜ã‚…ã‚“ã°ã‚“ãƒ¢ãƒ¼ãƒ‰</button>
        <button class="mode-btn" onclick="startMode('random')">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰</button>
        <button class="mode-btn" onclick="startMode('oboeru')">ğŸ”¥ ãŠã¼ãˆã‚‹ããƒ¢ãƒ¼ãƒ‰ (100%ã„ã‹)</button>
      </div>
    </div>

    <div id="cardContainer" class="card-container">
      <div class="card-info">
        <span id="progress">1 / 40</span>
        <div class="accuracy" id="accuracy">ã›ã„ã¨ã†ã‚Šã¤: --%</div>
      </div>
      <div class="card" id="card" onclick="flipCard()">
        <div class="card-front">
          <div class="question-text" id="question"></div>
        </div>
        <div class="card-back">
          <div class="answer-text" id="answer"></div>
        </div>
      </div>
      <div class="button-container">
        <button class="answer-btn correct-btn" onclick="answerQuestion(true)">âœ¨ ã‹ã‘ãŸ!</button>
        <button class="answer-btn wrong-btn" onclick="answerQuestion(false)">ğŸ’¦ ã‹ã‘ãªã‹ã£ãŸ</button>
      </div>
    </div>

    <div id="result" class="result">
      <h2>ğŸ‰ ãŠã¤ã‹ã‚Œã•ã¾! ğŸ‰</h2>
      <div class="result-stats" id="resultStats"></div>
      <button class="back-btn" onclick="backToMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚‚ã©ã‚‹</button>
    </div>

    <div id="loading" class="loading" style="display: none;">
      ã‚ˆã¿ã“ã¿ã¡ã‚…ã†... ğŸ’–
    </div>
  </div>

  <script>
    // Google Apps Script ã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURL
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyIpsYG55zXaoBFQIMUrQpk78YZkbFIYnw5qFdEqdlzHES2iJtcYS2jxGC3rRmmBQRlkQ/exec';

    let allQuestions = [];
    let currentQuestions = [];
    let currentIndex = 0;
    let correctCount = 0;
    let isFlipped = false;
    let currentMode = '';

    // åˆæœŸèª­ã¿è¾¼ã¿
    window.addEventListener('load', () => {
      loadData();
    });

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadData() {
      document.getElementById('loading').style.display = 'block';
      try {
        const response = await fetch(SCRIPT_URL);
        const data = await response.json();
        allQuestions = data;
        document.getElementById('loading').style.display = 'none';
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚');
        document.getElementById('loading').style.display = 'none';
      }
    }

    function startMode(mode) {
      currentMode = mode;
      let questions = [...allQuestions];

      // ãƒ¢ãƒ¼ãƒ‰åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      if (mode === 'oboeru') {
        // æ­£ç­”ç‡99%ä»¥ä¸‹ã®ã‚‚ã®ã‚’å…¨éƒ¨é¸ã¶
        questions = questions.filter(q => {
          if (q.total === 0) return true; // æœªå›ç­”ã¯å«ã‚ã‚‹
          const accuracy = (q.correct / q.total) * 100;
          return accuracy < 99; // 100%æœªæº€
        });
        // ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œ
        questions = shuffleArray(questions);
      } else if (mode === 'random') {
        // ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰
        questions = shuffleArray(questions);
      }
      // normalãƒ¢ãƒ¼ãƒ‰ã¯é †ç•ªã®ã¾ã¾

      if (questions.length === 0) {
        alert('ã‚‚ã‚“ã ã„ãŒã‚ã‚Šã¾ã›ã‚“!ã™ã”ã„!ãœã‚“ã¶ãŠã¼ãˆãŸã­!ğŸ‰');
        return;
      }

      // 40å•ã¾ã§ï¼ˆã˜ã‚…ã‚“ã°ã‚“ãƒ¢ãƒ¼ãƒ‰ã¨ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼‰ã€ãŠã¼ãˆã‚‹ããƒ¢ãƒ¼ãƒ‰ã¯å…¨éƒ¨
      let maxQuestions = 40;
      if (mode === 'oboeru') {
        maxQuestions = questions.length; // ã™ã¹ã¦å‡ºé¡Œ
      }

      currentQuestions = questions.slice(0, Math.min(maxQuestions, questions.length));
      currentIndex = 0;
      correctCount = 0;

      document.getElementById('menu').style.display = 'none';
      document.getElementById('cardContainer').style.display = 'block';
      showQuestion();
    }

    function shuffleArray(array) {
      const newArray = [...array];
      for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
      }
      return newArray;
    }

    function showQuestion() {
      if (currentIndex >= currentQuestions.length) {
        showResult();
        return;
      }

      const q = currentQuestions[currentIndex];
      document.getElementById('question').innerText = q.question;
      document.getElementById('answer').innerText = q.answer;
      document.getElementById('progress').innerText = `${currentIndex + 1} / ${currentQuestions.length}`;
      
      // æ­£ç­”ç‡è¡¨ç¤º
      if (q.total > 0) {
        const accuracy = Math.round((q.correct / q.total) * 100);
        document.getElementById('accuracy').innerText = `ã›ã„ã¨ã†ã‚Šã¤: ${accuracy}%`;
      } else {
        document.getElementById('accuracy').innerText = 'ã›ã„ã¨ã†ã‚Šã¤: --% (ã¯ã˜ã‚ã¦)';
      }

      isFlipped = false;
      document.getElementById('card').classList.remove('flipped');
    }

    function flipCard() {
      isFlipped = !isFlipped;
      document.getElementById('card').classList.toggle('flipped');
    }

    async function answerQuestion(isCorrect) {
      if (!isFlipped) {
        alert('ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã“ãŸãˆã‚’ã‹ãã«ã‚“ã—ã¦ã­!');
        return;
      }

      if (isCorrect) {
        correctCount++;
      }

      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²
      const q = currentQuestions[currentIndex];
      await updateGoogleSheet(q.row, isCorrect);

      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
      const questionIndex = allQuestions.findIndex(item => item.row === q.row);
      if (questionIndex !== -1) {
        if (isCorrect) {
          allQuestions[questionIndex].correct++;
        }
        allQuestions[questionIndex].total++;
      }

      currentIndex++;
      showQuestion();
    }

    async function updateGoogleSheet(row, isCorrect) {
      try {
        const url = `${SCRIPT_URL}?action=update&row=${row}&correct=${isCorrect}`;
        await fetch(url);
      } catch (error) {
        console.error('è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    function showResult() {
      document.getElementById('cardContainer').style.display = 'none';
      document.getElementById('result').style.display = 'block';
      
      const percentage = Math.round((correctCount / currentQuestions.length) * 100);
      let message = '';
      
      if (percentage >= 90) {
        message = 'ã™ã”ã„!ã‹ã‚“ãºã! ğŸŒŸ';
      } else if (percentage >= 70) {
        message = 'ã‚ˆããŒã‚“ã°ã£ãŸã­! ğŸ’®';
      } else if (percentage >= 50) {
        message = 'ã‚‚ã†ã™ã“ã—! ğŸ“';
      } else {
        message = 'ã¤ãã¯ãŒã‚“ã°ã‚ã†! ğŸ’ª';
      }

      document.getElementById('resultStats').innerHTML = `
        <div style="font-size: 2em; margin-bottom: 20px;">${message}</div>
        <div>ã‹ã‘ãŸ: ${correctCount} / ${currentQuestions.length}</div>
        <div>ã›ã„ã¨ã†ã‚Šã¤: ${percentage}%</div>
      `;
    }

    function backToMenu() {
      document.getElementById('result').style.display = 'none';
      document.getElementById('menu').style.display = 'block';
      loadData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
    }
  </script>
</body>
</html>
